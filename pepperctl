#!/usr/bin/env bash
# pepperctl - PepperWM command wrapper
# Depends on: list_windows, control_window, jq

for cmd in list_windows control_window jq; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd not found in PATH" >&2
        exit 1
    fi
done


usage() {
    cat <<EOF
Usage:
  pepperctl list                      List all windows
  pepperctl list <keyword>            List windows matching title or process
  pepperctl id <keyword>              Print the first matching PID@UID
  pepperctl move <target> x y w h     Move/resize by window ID or keyword
  pepperctl raw                       Output raw JSON from list_windows
EOF
    exit 0
}

[[ $# -lt 1 ]] && usage

action="$1"
shift

case "$action" in

  list)
    if [[ $# -eq 0 ]]; then
      list_windows | jq -r '.[] | "\(.ID)\t\(.Process)\t\(.Title)"'
    else
      query="$1"
      list_windows | jq -r --arg q "$query" \
        '.[] |
          select((.Title | test($q; "i")) or (.Process | test($q; "i"))) |
          "\(.ID)\t\(.Process)\t\(.Title)"'
    fi
    ;;


  id)
    [[ $# -lt 1 ]] && usage
    query="$1"
    list_windows | jq -r --arg q "$query" \
      '.[] |
        select((.Title | test($q; "i")) or (.Process | test($q; "i"))) |
        .ID' | head -n1
    ;;


  move)
    [[ $# -lt 5 ]] && usage

    query="$1"; shift
    x="$1"; y="$2"; w="$3"; h="$4"

    # Detect raw PID@UID pattern
    if [[ "$query" =~ ^[0-9]+@[0-9]+$ ]]; then
      id="$query"
    else
      # Find first match by title or process
      id=$(list_windows | jq -r --arg q "$query" \
         '.[] |
           select((.Title | test($q; "i")) or (.Process | test($q; "i"))) |
           .ID' | head -n1)
    fi

    if [[ -z "$id" ]]; then
        echo "No window matching \"$query\" found." >&2
        exit 1
    fi

    echo "Moving $id â†’ X=$x, Y=$y, W=$w, H=$h"
    control_window "$id" "$x" "$y" "$w" "$h"
    ;;

  raw)
    list_windows
    ;;
  *)
    usage
    ;;
esac